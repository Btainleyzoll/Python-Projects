import socket
from vulnerability_scanner import connect_port
from service_detection import find_banner
from vulnerability_db import find_vulnerabilities, load_nvd

def user_specifics():
    
    while True:
        ip = input("PLease enter the hostname or IP address: ")
        try:
            ip = socket.gethostbyname(ip) #converts hostname to IP
        except socket.gaierror: #makes sure the hostname is valid
            print("Please enter a valid hostname or IP")
            continue
        
        port_input = input("Please enter a port or range or ports (i.e 80, 20-1024), " +
                    "\nor if you would like, type 'common' to check common ports, \nor " +
                    "type 'all' to check all available ports: ").strip().lower()
        
        if port_input.strip().lower() == "all":
            print("Will try to connect to every port 0-65535. ")
            return ip, "all"
        elif port_input.strip().lower() == "common":
            print("Will try all the common ports, (21, 22, 23, 25, 53, 80 110, 143, 443, 3389)")
            return ip, "common"
        
        if "-" in port_input: #port range like 20-30
            try:
                start, end = map(int, port_input.split("-"))
                if 0 <= start <= 65535 and 0 <= end <= 65535 and start <= end:
                    return ip, list(range(start, end + 1))
                else:
                    print("Invalid port range")
            except ValueError:
                print("Invalid port format, i.e. 20-30")
                continue
            
        if "," in port_input:
            try:
                ports = [int(p.strip()) for p in port_input.split(",")]
                if all(0 <= p <= 65535 for p in ports):
                    return ip, ports
                else:
                    print("Ports must be between 0 and 65335 ")
                    continue
            except ValueError:
                print("invalid port format, only numbers are valid")
                continue
        try:
            port = int(port_input)
            if 0 <= port <= 65535:
                return ip, [port]
            else:
                print("Port must between 0 and 65535")
                continue
        except(ValueError):
            print("Invalid input, enter a valid port number or range")
            continue
        
if __name__ == "__main__":
    print("Welcome to my vulnerability port scanner")
    while True:
        ip, ports = user_specifics()
        ip, open_ports = connect_port(ip,ports)
        port_info = find_banner(ip, open_ports)
        nvd_data = load_nvd()
        
       # matcher(port_info, nvd_data)