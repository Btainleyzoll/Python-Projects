from vulnerability_scanner import connect_port
import socket
def find_banner(ip, open_ports):
    banner_keywords = [ #list of common keywords in banners
    # SSH
    "OpenSSH", "Dropbear", "libssh", "SSH",
    # HTTP / Web Servers
    "Apache", "nginx", "Microsoft-IIS", "LiteSpeed", "Caddy", "Gunicorn", "Jetty",
    # FTP
    "vsftpd", "ProFTPD", "Pure-FTPd", "FileZilla", "FTP",
    # SMTP / Mail Servers
    "Postfix", "Exim", "Sendmail", "Microsoft ESMTP", "Courier",
    # POP3 / IMAP
    "Dovecot", "Courier-IMAP", "Microsoft Exchange", "UW-IMAP",
    # Database Servers
    "MySQL", "PostgreSQL", "MongoDB", "Oracle", "Microsoft SQL Server", "MSSQL",
    # Other Common Services
    "Redis", "Memcached", "Tomcat", "ElasticSearch", "RabbitMQ"
]
    port_info = {}
    msg = "datagram"
    version = ""
    for port in open_ports:
        
        #iterates through every open port
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(1)
        try:
            match = socket.getservbyport(port, "tcp")
        except OSError:
            match = "Unknown"
        try:
            sock.connect((ip, port))
            
            try: 
                sock.send(msg.encode()) # sends a msg incase the port needs a probe
                banner = sock.recv(2048)
                serviceVersion = str(banner.decode())
                for check in banner_keywords:
                    if check in serviceVersion:
                        version = ""
                        #checks to see if the common banner names are in the banner
                        before, match, after = serviceVersion.partition(check)
                        
                        for x in after:
                            if x == " " or x == "/" or x == "_" or x == "\n" or x == "-":
                                break
                            else:
                                version += x
                                    
                        break
  
            except:
                pass
            
            
            port_info[port] = {"service": match, "version": version}
            
            
             
            
        except (socket.timeout, ConnectionRefusedError): # in case the socket cannot connect
            port_info[port] = {"service": None, "version": None}
        finally:
            sock.close()
    return port_info
                
            